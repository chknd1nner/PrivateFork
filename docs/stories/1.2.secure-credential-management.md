# Story 1.2: Secure Credential Management

## Status
Draft

## Story
As a user, I want to securely save my GitHub credentials in the app, so that I don't have to enter them every time I use the utility.

## Acceptance Criteria
1. A Settings view is created with fields for "GitHub Username" and "Personal Access Token".
2. The Personal Access Token input field is secured (obscured/masked) to prevent shoulder surfing.
3. A "Validate & Save" button exists on the Settings view.
4. Clicking "Validate & Save" with valid credentials successfully saves the username and PAT to the macOS Keychain.
5. Clicking "Validate & Save" with invalid credentials displays a clear error message to the user and does not save the credentials.
6. A "Clear" button on the Settings view removes any saved credentials from the Keychain.
7. The Settings view is accessible from the main application view (e.g., via a settings button or menu item).

## Tasks / Subtasks
- [ ] Create SettingsView SwiftUI component (AC: 1, 2, 7)
  - [ ] Create Views/SettingsView.swift following component template
  - [ ] Add form fields for GitHub Username and Personal Access Token
  - [ ] Implement SecureField for Personal Access Token input (AC: 2)
  - [ ] Add "Validate & Save" and "Clear" buttons
  - [ ] Implement sheet presentation from MainView
- [ ] Create SettingsViewModel with state management (AC: 3, 4, 5, 6)
  - [ ] Create ViewModels/SettingsViewModel.swift with @MainActor
  - [ ] Add @Published properties for username, token, validation status, error messages
  - [ ] Implement dependency injection for KeychainService
  - [ ] Add validation and save logic using async/await
- [ ] Create KeychainServiceProtocol and implementation (AC: 4, 5, 6)
  - [ ] Create Services/Protocols/KeychainServiceProtocol.swift
  - [ ] Create Services/Implementations/KeychainService.swift
  - [ ] Implement save, retrieve, and delete operations using Security framework
  - [ ] Return Result<Success, Error> types for all operations
- [ ] Create GitHubValidationService for credential validation (AC: 5)
  - [ ] Create Services/Protocols/GitHubValidationServiceProtocol.swift
  - [ ] Create Services/Implementations/GitHubValidationService.swift
  - [ ] Implement async credential validation against GitHub API
- [ ] Integrate SettingsView into MainView (AC: 7)
  - [ ] Add settings button or menu item to MainView
  - [ ] Implement sheet presentation logic
  - [ ] Update MainViewModel to handle settings sheet state
- [ ] Create comprehensive unit tests
  - [ ] Create PrivateForkTests/ViewModels/SettingsViewModelTests.swift
  - [ ] Create PrivateForkTests/Mocks/MockKeychainService.swift
  - [ ] Create PrivateForkTests/Mocks/MockGitHubValidationService.swift
  - [ ] Test all validation scenarios, save/clear operations, and error handling

## Dev Notes

### Previous Story Insights
From Story 1.1: Pay attention to Swift Package Framework References issue. When creating service implementations, ensure proper UUID consistency if additional frameworks are needed. However, this story should only use native macOS frameworks (Security framework for Keychain).

### Project Structure
Following the MVVM pattern from the source tree, credential management components should be organized as:
- **Views/SettingsView.swift**: SwiftUI view for credential input [Source: docs/architecture/source-tree.md#views]
- **ViewModels/SettingsViewModel.swift**: Logic and state management [Source: docs/architecture/source-tree.md#viewmodels]
- **Services/Protocols/KeychainServiceProtocol.swift**: Keychain abstraction [Source: docs/architecture/source-tree.md#services]
- **Services/Implementations/KeychainService.swift**: Concrete Keychain implementation [Source: docs/architecture/source-tree.md#services]

### Component Standards
SettingsView must follow the component template structure with:
- @StateObject for ViewModel ownership
- UI elements bound to @Published properties
- Actions calling ViewModel methods
- Disabled state based on ViewModel state
- **SecureField for PAT input**: Use SecureField instead of TextField for Personal Access Token to ensure input is masked
[Source: docs/architecture/component-standards.md#component-template]

### Coding Standards Requirements
- **MVVM Pattern**: SettingsView for display only, SettingsViewModel contains all logic [Source: docs/architecture/coding-standards.md#critical-coding-rules]
- **Protocol-Oriented Programming**: KeychainService abstracted behind KeychainServiceProtocol [Source: docs/architecture/coding-standards.md#critical-coding-rules]
- **Dependency Injection**: Services injected into SettingsViewModel during initialization [Source: docs/architecture/coding-standards.md#critical-coding-rules]
- **@MainActor**: SettingsViewModel must be marked with @MainActor [Source: docs/architecture/coding-standards.md#critical-coding-rules]
- **Asynchronous Operations**: Credential validation must use async/await [Source: docs/architecture/coding-standards.md#critical-coding-rules]
- **Result Type**: All service operations return Result<Success, Error> [Source: docs/architecture/coding-standards.md#critical-coding-rules]

### Technology Stack
- **Framework**: SwiftUI 5.0+ for UI components [Source: docs/architecture/tech-stack.md]
- **Language**: Swift 5.10+ [Source: docs/architecture/tech-stack.md]
- **Dependencies**: Native Apple frameworks only (Security framework for Keychain) [Source: docs/architecture/tech-stack.md]

### Keychain Implementation Details
Use native macOS Security framework for Keychain operations:
- Store credentials with service identifier "com.example.PrivateFork.github"
- Username as account parameter
- Personal Access Token as password data
- Implement proper error handling for Keychain status codes

### State Management Pattern
SettingsViewModel should follow the state management template:
- @Published properties for username, token, isValidating, errorMessage, isSaved
- Dependency injection in init() with default implementations
- Public methods called by SettingsView for validate, save, clear actions
[Source: docs/architecture/state-management.md#state-management-template]

### Naming Conventions
- **Views**: SettingsView.swift [Source: docs/architecture/component-standards.md#naming-conventions]
- **ViewModels**: SettingsViewModel.swift [Source: docs/architecture/component-standards.md#naming-conventions]
- **Service Protocols**: KeychainServiceProtocol.swift, GitHubValidationServiceProtocol.swift [Source: docs/architecture/component-standards.md#naming-conventions]
- **Service Implementations**: KeychainService.swift, GitHubValidationService.swift [Source: docs/architecture/component-standards.md#naming-conventions]

### Testing
All ViewModels and Services require comprehensive unit tests following Given-When-Then structure using XCTest. Mock all external dependencies for isolation.
[Source: docs/architecture/testing-requirements.md#testing-best-practices]

Test files should be located in:
- PrivateForkTests/ViewModels/SettingsViewModelTests.swift
- PrivateForkTests/Mocks/MockKeychainService.swift
- PrivateForkTests/Mocks/MockGitHubValidationService.swift
[Source: docs/architecture/testing-requirements.md#component-test-template]

## Change Log
| Date       | Version | Description         | Author |
|------------|---------|---------------------|--------|
| 2025-07-15 | 0.1     | Initial draft       | SM     |