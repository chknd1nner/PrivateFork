# Story 1.4b: GitHub API Integration Service

## Status
Approved

## Story
**As a** developer implementing the core automation logic,
**I want** a comprehensive GitHub API service that can create private repositories using stored credentials,
**so that** the private fork operation can create the target repository programmatically.

## Acceptance Criteria
1. A GitHubService is created that can authenticate using credentials from the Keychain.
2. The service can create a private repository with a specified name on GitHub.
3. The service handles GitHub API errors gracefully and returns meaningful error messages.
4. The service validates that the GitHub credentials are valid before attempting operations.
5. All GitHub operations return Result types for explicit error handling.

## Tasks / Subtasks
- [ ] Create GitHubService protocol and implementation (AC: 1, 5)
  - [ ] Define GitHubServiceProtocol with required methods
  - [ ] Implement GitHubService concrete class
  - [ ] Add dependency injection support for testing
  - [ ] Integrate with existing KeychainService for credential retrieval
- [ ] Implement GitHub authentication (AC: 1, 4)
  - [ ] Add GitHub API authentication using Personal Access Token
  - [ ] Implement credential validation against GitHub API
  - [ ] Add secure credential handling from Keychain
  - [ ] Handle authentication errors and token validation
- [ ] Implement private repository creation (AC: 2)
  - [ ] Add GitHub API call to create private repository
  - [ ] Handle repository naming and configuration
  - [ ] Support repository description and settings
  - [ ] Return repository details on successful creation
- [ ] Implement comprehensive error handling (AC: 3)
  - [ ] Handle GitHub API rate limiting
  - [ ] Handle network connectivity issues
  - [ ] Handle invalid credentials and permissions
  - [ ] Handle repository name conflicts and validation errors
  - [ ] Provide user-friendly error messages
- [ ] Create URLProtocol mock infrastructure for testing
  - [ ] Implement parallel-safe MockURLProtocol for network request mocking
  - [ ] Design thread-safe request/response mapping for isolated test execution
  - [ ] Integrate with existing test architecture patterns
- [ ] Create comprehensive unit tests
  - [ ] Test GitHub authentication with valid/invalid credentials
  - [ ] Test repository creation success and failure scenarios
  - [ ] Test error handling for all API failure modes
  - [ ] Test integration with KeychainService
  - [ ] Test Result type returns and error propagation

## Dev Notes

### Previous Story Insights
From Story 1.2: The project successfully implements secure credential management with KeychainService for GitHub username and Personal Access Token storage. From Story 1.4a: CLI infrastructure will be available for headless operation. The GitHub API service will be used by both GUI and CLI modes.

### Project Structure
Following the MVVM pattern from the source tree, GitHub API components should be organized as:
- **Services/Protocols/GitHubServiceProtocol.swift**: Protocol defining GitHub operations [Source: docs/architecture/source-tree.md#services]
- **Services/Implementations/GitHubService.swift**: Concrete implementation for GitHub API [Source: docs/architecture/source-tree.md#services]
- **Models/GitHubModels.swift**: Data models for GitHub API requests/responses [Source: docs/architecture/source-tree.md#models]
- **Utilities/**: Network utilities if needed for GitHub API calls [Source: docs/architecture/source-tree.md#utilities]

### Component Standards
GitHub service must follow the established service pattern:
- GitHubService must conform to GitHubServiceProtocol for dependency injection
- All methods must be async and return Result types
- Service must be injectable into ViewModels and CLI controllers
- Follow the same pattern as established in KeychainService
[Source: docs/architecture/component-standards.md#component-template]

### Coding Standards Requirements
- **Protocol-Oriented Programming (POP)**: GitHubService must be abstracted behind GitHubServiceProtocol [Source: docs/architecture/coding-standards.md#critical-coding-rules]
- **Dependency Injection**: Service will be injected into ViewModels during initialization [Source: docs/architecture/coding-standards.md#critical-coding-rules]
- **Asynchronous Operations**: All GitHub API calls must use async/await [Source: docs/architecture/coding-standards.md#critical-coding-rules]
- **Result Type for Outcomes**: All service operations must return Result<Success, Error> [Source: docs/architecture/coding-standards.md#critical-coding-rules]
- **Single Responsibility Principle**: GitHub API logic belongs only in GitHubService [Source: docs/architecture/coding-standards.md#critical-coding-rules]

### Technology Stack
- **Framework**: Foundation for networking, URLSession for HTTP requests [Source: docs/architecture/tech-stack.md]
- **Language**: Swift 5.10+ [Source: docs/architecture/tech-stack.md]
- **Dependencies**: Native Apple frameworks only (Foundation, Security for Keychain integration) [Source: docs/architecture/tech-stack.md]
- **API**: GitHub REST API v3 for repository operations [Source: docs/architecture/tech-stack.md]

### API Integration Pattern
GitHub service must follow the established service template:
```swift
protocol GitHubServiceProtocol {
    func validateCredentials() async -> Result<GitHubUser, Error>
    func createPrivateRepository(name: String, description: String?) async -> Result<GitHubRepository, Error>
}

struct GitHubService: GitHubServiceProtocol {
    private let keychainService: KeychainServiceProtocol
    
    func validateCredentials() async -> Result<GitHubUser, Error> {
        // Use async/await to validate GitHub credentials
        // Return a Result type to handle success or failure
    }
}
```
[Source: docs/architecture/api-integration.md#service-template]

### GitHub API Specifications
The service must implement these specific GitHub API operations:
- **Authentication**: Validate Personal Access Token using `/user` endpoint
- **Repository Creation**: Create private repository using `/user/repos` endpoint
- **Error Handling**: Handle standard GitHub API error responses (401, 403, 422, etc.)
- **Rate Limiting**: Respect GitHub API rate limits and provide appropriate feedback

### Data Models Requirements
Create GitHubModels.swift with:
- GitHubRepository: Model for repository creation response
- GitHubUser: Model for user authentication response
- GitHubAPIError: Decodable model for parsing GitHub API error responses with message and documentation_url fields
- GitHubCredentials: Model for credential validation
[Source: docs/architecture/source-tree.md#models]

### Integration with Existing Services
This story builds on existing KeychainService:
- Use KeychainServiceProtocol to retrieve GitHub username and PAT
- Follow the same dependency injection pattern established in MainViewModel
- Use the same error handling patterns for credential operations
[Source: Previous story 1.2]

### Security Considerations
- Never log or expose Personal Access Tokens in error messages
- Use secure credential storage through KeychainService only
- Validate all API responses to prevent injection attacks
- Handle credential expiration and rotation scenarios
- Document minimum required PAT scope (repo) for users during credential setup
- Implement credential rotation detection on 401 Unauthorized responses
- Use structured GitHubServiceError types for credential-related failures

### Network and Error Handling
- Implement proper timeout handling for GitHub API calls
- Handle network connectivity issues gracefully
- Provide specific error messages for different failure scenarios:
  - Invalid credentials (401)
  - Insufficient permissions (403)
  - Repository name conflicts (422)
  - Rate limiting (429)
  - Network failures
- Rate Limiting Strategy: Fail fast with structured .rateLimited(retryAfter: Date?) error
- Structured Error Responses: Parse GitHub API JSON error responses via GitHubAPIError model
- API Configuration: Use configurable base URL (https://api.github.com) for testing flexibility

### Testing

**Test File Locations:**
- PrivateForkTests/Services/GitHubServiceTests.swift (new file for GitHub service testing)
- PrivateForkTests/Models/GitHubModelsTests.swift (new file for GitHub models testing)
- PrivateForkTests/Mocks/MockGitHubService.swift (new file for mocking in other tests)
- PrivateForkTests/Mocks/MockURLProtocol.swift (new file for network request mocking)

**Test Standards:**
- All GitHub service methods require comprehensive unit tests following Given-When-Then structure using XCTest
- Framework: XCTest exclusively (standardized across all test targets)
- Bundle ID: Tests use com.example.PrivateFork.UnitTests for proper isolation
- Test Host: Configured with $(BUILT_PRODUCTS_DIR)/PrivateFork.app/Contents/MacOS/PrivateFork
- Mock dependencies: KeychainService via existing MockKeychainService patterns
- Network mocking: URLProtocol-based mocking for robust, parallel-safe testing

**URLProtocol Mocking Strategy:**
- Use custom MockURLProtocol subclass for intercepting network requests
- Implement stateless, thread-safe request/response mapping
- Configure URLSession with MockURLProtocol for isolated test execution
- Avoid static variables to enable parallel test execution

**Async Testing Patterns:**
- Use native async throws test functions for testing async/await code
- Example: `func testCreateRepository() async throws { ... }`
- Leverage established async testing patterns from phases 1-4 test refactoring

**Specific Testing Requirements:**
- Authentication: Test credential validation returning GitHubUser model
- Repository Creation: Test successful creation and various failure scenarios
- Error Handling: Test GitHubAPIError parsing and structured error responses
- Rate Limiting: Test 429 responses and retry-after header handling
- Integration: Test integration with KeychainService for credential retrieval
- Security: Test that credentials are never exposed in logs or errors

## Change Log
| Date       | Version | Description                           | Author |
|------------|---------|---------------------------------------|--------|
| 2025-07-17 | 0.1     | Initial GitHub API service story from 1.4 split | SM     |
| 2025-07-18 | 0.2     | Updated per Gemini recommendations and test architecture changes | SM     |

## Dev Agent Record
*This section is populated by the development agent during implementation*

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results