# Story 1.4c: Git Automation Service

## Status
Approved

## Story
**As a** developer implementing the core automation logic,
**I want** a comprehensive Git automation service that can perform repository operations via shell commands,
**so that** the private fork operation can clone, configure remotes, and push to the new private repository.

## Acceptance Criteria
1. A GitService is created that can execute Git shell commands asynchronously.
2. The service can clone a public repository to a specified local directory.
3. The service can configure Git remotes (origin and upstream).
4. The service can push the cloned repository to a new private remote origin.
5. The service handles Git command failures gracefully and returns meaningful error messages.
6. All Git operations return Result types for explicit error handling.

## Tasks / Subtasks
- [ ] Create GitService protocol and implementation (AC: 1, 6)
  - [ ] Define GitServiceProtocol with required Git operations
  - [ ] Implement GitService concrete class using Shell utility
  - [ ] Add dependency injection support for testing
  - [ ] Integrate with Shell.swift utility for command execution
- [ ] Implement Git clone functionality (AC: 2)
  - [ ] Add git clone command execution with URL and destination path
  - [ ] Handle clone progress and status reporting
  - [ ] Validate clone success and handle failures
  - [ ] Support authentication for private repositories if needed
- [ ] Implement Git remote configuration (AC: 3)
  - [ ] Add remote addition (git remote add)
  - [ ] Add remote URL modification (git remote set-url)
  - [ ] Configure upstream and origin remotes properly
  - [ ] Validate remote configuration success
- [ ] Implement Git push functionality (AC: 4)
  - [ ] Add git push command execution to new origin
  - [ ] Handle push authentication using stored credentials
  - [ ] Support force push scenarios if needed
  - [ ] Validate push success and handle failures
- [ ] Implement comprehensive error handling (AC: 5)
  - [ ] Handle Git command execution failures
  - [ ] Parse Git error output for meaningful messages
  - [ ] Handle authentication failures
  - [ ] Handle network connectivity issues
  - [ ] Handle directory and permission errors
- [ ] Create Shell.swift utility (dependency for GitService)
  - [ ] Implement async shell command execution
  - [ ] Add command output capturing
  - [ ] Add error handling and exit code checking
  - [ ] Add timeout support for long-running commands
- [ ] Create comprehensive unit tests
  - [ ] Test Git clone with valid/invalid repositories
  - [ ] Test remote configuration success and failure scenarios
  - [ ] Test Git push operations and authentication
  - [ ] Test error handling for all Git failure modes
  - [ ] Test Shell utility command execution

## Dev Notes

### Previous Story Insights
From Story 1.2: The project successfully implements secure credential management with KeychainService for GitHub authentication. From Story 1.4a: CLI infrastructure provides patterns for async operations and Result types. From Story 1.4b: GitHub API service provides patterns for service implementation and error handling.

### Project Structure
Following the MVVM pattern from the source tree, Git automation components should be organized as:
- **Services/Protocols/GitServiceProtocol.swift**: Protocol defining Git operations [Source: docs/architecture/source-tree.md#services]
- **Services/Implementations/GitService.swift**: Concrete implementation for Git commands [Source: docs/architecture/source-tree.md#services]
- **Utilities/Shell.swift**: Utility for running shell commands [Source: docs/architecture/source-tree.md#utilities]
- **Models/GitModels.swift**: Data models for Git operations if needed [Source: docs/architecture/source-tree.md#models]

### Component Standards
Git service must follow the established service pattern:
- GitService must conform to GitServiceProtocol for dependency injection
- All methods must be async and return Result types
- Service must be injectable into ViewModels and CLI controllers
- Follow the same pattern as established in KeychainService and GitHubService
[Source: docs/architecture/component-standards.md#component-template]

### Coding Standards Requirements
- **Protocol-Oriented Programming (POP)**: GitService must be abstracted behind GitServiceProtocol [Source: docs/architecture/coding-standards.md#critical-coding-rules]
- **Dependency Injection**: Service will be injected into ViewModels during initialization [Source: docs/architecture/coding-standards.md#critical-coding-rules]
- **Asynchronous Operations**: All Git shell commands must use async/await [Source: docs/architecture/coding-standards.md#critical-coding-rules]
- **Result Type for Outcomes**: All service operations must return Result<Success, Error> [Source: docs/architecture/coding-standards.md#critical-coding-rules]
- **Single Responsibility Principle**: Git command logic belongs only in GitService [Source: docs/architecture/coding-standards.md#critical-coding-rules]

### Technology Stack
- **Framework**: Foundation for process execution and file management [Source: docs/architecture/tech-stack.md]
- **Language**: Swift 5.10+ [Source: docs/architecture/tech-stack.md]
- **Dependencies**: Native Apple frameworks only (Foundation, Process for shell commands) [Source: docs/architecture/tech-stack.md]
- **Shell Commands**: Git CLI commands executed via Process [Source: docs/architecture/tech-stack.md]

### API Integration Pattern
Git service must follow the established service template:
```swift
protocol GitServiceProtocol {
    func clone(repoURL: URL, to localPath: URL) async -> Result<String, Error>
    func addRemote(name: String, url: URL, at path: URL) async -> Result<String, Error>
    func push(remoteName: String, branch: String, at path: URL) async -> Result<String, Error>
}

struct GitService: GitServiceProtocol {
    private let shell: ShellProtocol
    
    func clone(repoURL: URL, to localPath: URL) async -> Result<String, Error> {
        // Use async/await to run shell command
        // Return a Result type to handle success or failure
    }
}
```
[Source: docs/architecture/api-integration.md#service-template]

### Shell Utility Requirements
The Shell.swift utility must provide:
- Async command execution using Process
- Command output and error capturing
- Exit code checking and validation
- Timeout support for long-running operations
- Secure handling of command arguments to prevent injection

### Git Command Specifications
The service must implement these specific Git operations:
- **Clone**: `git clone <url> <destination>` with progress tracking
- **Remote Add**: `git remote add <name> <url>` for origin/upstream setup
- **Remote Set URL**: `git remote set-url <name> <url>` for reconfiguration
- **Push**: `git push <remote> <branch>` with authentication
- **Status Check**: `git status` for validation after operations

### Security and Authentication
- Use Git credential helper for authentication with stored credentials
- Ensure credentials are passed securely to Git commands
- Validate all paths to prevent directory traversal attacks
- Handle Git credential caching appropriately

### Error Handling Patterns
Git operations can fail in multiple ways:
- **Network Issues**: Clone/push failures due to connectivity
- **Authentication**: Invalid or expired credentials
- **File System**: Permission or disk space issues
- **Git Errors**: Invalid repositories, conflicting states
- **Command Failures**: Git command execution errors

### Integration with Existing Services
This story builds on patterns from previous services:
- Follow the same dependency injection pattern as GitHubService
- Use similar error handling patterns for async operations
- Integrate with credential management established in KeychainService
[Source: Previous stories 1.2, 1.4a, 1.4b]

### Directory and File Management
- Validate destination directories exist or can be created
- Handle file system permissions appropriately
- Clean up partial operations on failure
- Provide appropriate feedback for file system operations

### Testing

**Run Tests**: Use XcodeBuildMCP tool: test_macos_proj, fallback: Execute `xcodebuild test -scheme PrivateFork -quiet`

**Expected Result**: All tests must pass before story completion - no exceptions.

**Test File Locations:**
- PrivateForkTests/Services/GitServiceTests.swift (new file for Git service testing)
- PrivateForkTests/Utilities/ShellTests.swift (new file for Shell utility testing)
- PrivateForkTests/Mocks/MockGitService.swift (new file for mocking in other tests)
- PrivateForkTests/Mocks/MockShell.swift (new file for mocking shell commands)

**Component Test Template for GitService:**
```swift
import XCTest  
@testable import PrivateFork

@MainActor
final class GitServiceTests: XCTestCase {

    var gitService: GitService!  
    var mockShell: MockShell!

    override func setUp() {  
        super.setUp()  
        // REQUIRED: Inject mock dependencies - direct init will use real shell
        mockShell = MockShell()
        gitService = GitService(shell: mockShell)  
    }

    func testCloneRepository_WhenSuccessful_ShouldReturnSuccess() async {  
        // Given: A valid repo URL and successful shell execution  
        let repoURL = URL(string: "https://github.com/user/repo")!
        let localPath = URL(fileURLWithPath: "/tmp/test")
        mockShell.executeResult = .success("Cloning completed")

        // When: The clone operation is called  
        let result = await gitService.clone(repoURL: repoURL, to: localPath)

        // Then: The operation should succeed  
        switch result {
        case .success(let message):
            XCTAssertEqual(message, "Cloning completed")
        case .failure:
            XCTFail("Clone should have succeeded")
        }
    }  
}
```

**Critical Implementation Requirements:**
- **Test Environment Protection**: GitService must use dependency injection with MockShell for all tests
- **Async Testing**: Use async/await test functions for all Git operations
- **Performance**: Eliminate `Task.sleep` from unit tests by using configurable timeouts
- **Error Scenarios**: Test all Git command failure modes comprehensively

**Mandatory Testing Standards:**
- **XCTest Framework**: Use XCTest consistently across all test targets
- **Given-When-Then Structure**: Strictly follow Arrange-Act-Assert pattern
- **Mock Dependencies**: All shell command execution MUST be mocked in unit tests
- **Coverage Goals**: Maintain >90% code coverage on GitService logic
- **Integration Tests**: Validate component interactions in PrivateForkTests/Integration/

**Specific Testing Requirements for This Story:**
- **Clone Operations**: Test successful clone, invalid URLs, network failures, permission errors
- **Remote Configuration**: Test remote addition, URL configuration, validation failures
- **Push Operations**: Test successful push, authentication failures, network issues
- **Error Handling**: Test Git command parsing, timeout scenarios, exit code handling
- **Shell Utility**: Test command execution, output capturing, timeout, security validation

## Change Log
| Date       | Version | Description                           | Author |
|------------|---------|---------------------------------------|--------|
| 2025-07-17 | 0.1     | Initial Git automation service story from 1.4 split | SM     |

## Dev Agent Record
*This section is populated by the development agent during implementation*

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results